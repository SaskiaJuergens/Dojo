<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabellenzeile hinzufügen</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="css/StyleSheet.css" />
</head>

<body>
    <button id="backBtn">Zurück Starseite</button>
    <button id="printAllBtn">alle Auswertungsbogen ausdrucken</button>
    <button id="FinalTableBtn">Zur Auswertungsliste</button>

    <div class="table-container">
        <br>
        <h1>Probe Tabelle</h1>
        <table class="table" id="TeilenhmerTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Name</th>
                    <th onclick="sortTable(1)">Vorname</th>
                    <th onclick="sortTable(2)">Geschlecht</th> <!--Drop Down: Weiblich, Männlich, Nonbinär-->
                    <th onclick="sortTable(3)">Geburstdatum</th>
                    <th onclick="sortTable(4)">Alter<button>!</button></th> <!-- Kind (bis 13), Jugendlich (14-18), Erwachsen (ab18 - dann auch erst schwarz Gurt erlaubt)-->
                    <th onclick="sortTable(5)">Nationalität</th>
                    <th onclick="sortTable(6)">Verein</th>
                    <th onclick="sortTable(7)">Graduierung</th> <!--Mokuroku (Weiß)  (木録) - Grundstufe 6.Kyu
                                            Shoden (Gelb)  (初伝) - Erste Stufe 5. Kyu
                                            Chuden (Orange)  (中伝) - Mittelstufe 4. Kyu
                                            Okuden (Grün) (奥伝) - Innere Stufe 3.Kyu
                                                (Blau) 2.Kyu
                                                (Braun) 1.Kyu
                                            Menkyo (Schwarz)  (免許) - Meisterstufe-->
                   
                    <th>Schnellbogenschießen</th>
                    <th>Control Center</th>

                </tr>
            </thead>
            <tbody id="tbody1">
                <!-- Placeholder for dynamic data -->
            </tbody>
            <tbody id="addTeil">
                <tr>
                    <td> <input placeholder="Name" type="text" id="name" /> </td>
                    <td> <input placeholder="Vorname" type="text" id="vorname" /> </td>
                    <td> <select id="sexID" aria-label="Geschlecht">
                        <option value="Weiblich">Weiblich</option> 
                        <option value="Männlich">Männlich</option>
                        <option value="Non-binär">Non-binär</option>
                    <td> <input placeholder="Geburstdatum" type="date" id="data" /> </td>
                    <td> <input placeholder="Alter" type="number" id="age" /> </td>
                    <td> <input placeholder="Nationalität" type="text" id="nation" /> </td>
                    <td> <input placeholder="Verein" type="text" id="verein" /> </td>
                    <td>    <select id="rankID" aria-label="Graduierung">
                        <option value="Mokuroku">Mokuroku</option>
                        <option value="Shoden">Shoden</option>
                        <option value="Chuden">Chuden</option>
                        <option value="Okuden">Okuden</option>
                        <option value="Menkyo">Menkyo</option>
                    </select> </td>
                    <td></td>
                    <td><button id="AddBtn">Hinzufügen</button>
                </tr>
            </tbody>
        </table>
    </div>


    <!-- Modal Start -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Teilnehmerdaten bearbeiten</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body">
                <!-- Formularfelder für Bearbeitung hier einfügen -->
                <label class="labs"> Name: </label>
                <input type="text" id="NameMod"> <br>
                <label class="labs"> Vorname: </label>
                <input type="text" id="VornameMod"> <br>
                <label class="labs"> Geschlecht: </label>
                <select id="SexMod" aria-label="Geschlecht">
                <option value="Weiblich">Weiblich</option> 
                <option value="Männlich">Männlich</option>
                <option value="Non-binär">Non-binär</option></select> <br>
                <label class="labs"> Geburstdatum: </label>
                <input type="date" id="DataMod"/> <br>
                <label class="labs"> Alter: </label>
                <input type="number" id="AgeMod"/> <br>
                <label class="labs"> Nationalität: </label>
                <input type="text" id="NationMod"/> <br>
                <label class="labs"> Verein: </label>
                <input type="text" id="VereinMod"/> <br>
                <label class="labs"> Graduierung: </label>
                <select id="RankMod" aria-label="Graduierungt">
                <option value="Mokuroku">Mokuroku</option>
                <option value="Shoden">Shoden</option>
                <option value="Chuden">Chuden</option>
                <option value="Okuden">Okuden</option>
                <option value="Menkyo">Menkyo</option></select>
            </div>
            <div class="modal-footer">
                <button id="UpdModBtn" type="button" class="btn btn-success" data-dismiss="modal" onclick="UpdTeil()">Speichern</button>
                <button id="DeleteModBtn" type="button" class="btn btn-danger" data-dismiss="modal" onclick="DelTeil()">Löschen</button>
            </div>
        </div>
        </div>
    </div>
    <!-- Modal Ende -->

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script src="js/TabelSort.js"></script>
    <script src="js/switchPage.js"></script>

    <script type="module">
    //-------------Firebase DB Conection ----------->
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA8AWwq9SWpTjLwxzVaVKuo6HcVdfH5FhU",
            authDomain: "dojo-website-d7f0c.firebaseapp.com",
            databaseURL: "https://dojo-website-d7f0c-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dojo-website-d7f0c",
            storageBucket: "dojo-website-d7f0c.appspot.com",
            messagingSenderId: "157008216879",
            appId: "1:157008216879:web:461d14ed280ed2a6ab17da"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        import{getDatabase, ref, child, onValue, get, set, update, remove} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";
        const db = getDatabase();     



        // Extrahiere den tableName aus der URL
        var urlParams = new URLSearchParams(window.location.search);
        var tableName = urlParams.get('tableName');
        // Verwende den tableName auf der Seite
        console.log('TableName:', tableName);



        //----------Add Teilnehmer-------->
        var Nummer = 0;
        let Fname = document.getElementById('vorname');
        let Lname = document.getElementById('name');
        let Datum = document.getElementById('data');
        let Age = document.getElementById('age');
        let Rank = document.getElementById('rankID');
        let Sex = document.getElementById('sexID');
        let Nation = document.getElementById('nation');
        let Verein = document.getElementById('verein');
        
        let AddBtn = document.getElementById('AddBtn');
        
        function AddData(){
        // Überprüfen, ob die Nummer bereits in der Datenbank vorhanden ist
        let numRef = ref(db, 'Tabellen/' + tableName + '/Teilnehmer/' + Nummer);
        get(numRef)
        .then((snapshot) => {
            if (snapshot.exists()) {
                // Wenn die Nummer bereits vorhanden ist, inkrementieren Sie Nummer und versuchen Sie es erneut
                Nummer++;
                AddData(); // Rekursiver Aufruf der Funktion, um erneut zu versuchen
            } else {
                set(ref(db, 'Tabellen/' + tableName + '/Teilnehmer/' + Nummer), { // Verwenden Sie die erhöhte Nummer
                    Vorname: Fname.value,
                    Name: Lname.value,
                    Geburstdatum: Datum.value,
                    Alter: Number(Age.value),
                    Graduierung: Rank.value,
                    Geschlecht: Sex.value,
                    Nationalität: Nation.value,
                    Verein: Verein.value,
                    Schnellbogenschießen: {
                    Platzierung: 0,
                    Sekunden: 0
                    },
                    Präzisionschießen: {
                        Pkt: 0,
                        Platzierung: 0
                    },
                    Wehrturm: {
                        Pkt: 0,
                        Platzierung: 0
                    }
                })
                .then(()=>{
                    alert("Daten erfolgreich hinzugefügt");
                })
                .catch((error)=>{
                    alert("Unsuccessful");
                    console.log(error);
                })
            }
        })
        .catch((error) => {
            console.error("Error getting document:", error);
        });
        }
        AddBtn.addEventListener('click', AddData);


//-------------Getting all Data ----------->
        function GetAllDataOnce(){
            const dbRef = ref(db);

            get(child(dbRef, "Tabellen/" + tableName + "/Teilnehmer"))
            .then((snapshot)=>{
                var teilnehmer = [];
                snapshot.forEach(childSnapshot => {
                    teilnehmer.push(childSnapshot.val());
                });

                AddAllTeilnehmer(teilnehmer);
            })
        }

        function GetAllDataRealTime(){
            const dbRef = ref(db, "Tabellen/" + tableName + "/Teilnehmer");

            onValue(dbRef,(snapshot)=>{
                var teilnehmer = [];
                snapshot.forEach(childSnapshot => {
                    teilnehmer.push(childSnapshot.val());
                });
                AddAllTeilnehmer(teilnehmer);
            })
        }

        window.onload = GetAllDataRealTime;

    //-------- Filling Tabelle -------->
        //var Nummer = 0;
        var teilnehmerList = [];
        var tbody = document.getElementById('tbody1');

        function AddTeilnehmer(name, vorname, data, age, rank, sex, nation, verein) {
            var trow = document.createElement("tr");
            var td0 = document.createElement("td");
            var td1 = document.createElement("td");
            var td2 = document.createElement("td");
            var td3 = document.createElement("td");
            var td4 = document.createElement("td");
            var td5 = document.createElement("td");
            var td6 = document.createElement("td");
            var td7 = document.createElement("td");
            var td8 = document.createElement("td");
            var td9 = document.createElement("td");
            var ratingButton = document.createElement("td");
            var ControlDiv = document.createElement("td");

            teilnehmerList.push([name, vorname, sex, data, age, nation, verein, rank]); /*Teilnehmerliste füllen*/

            td0.innerHTML = ++Nummer;
            td1.innerHTML = name;
            td2.innerHTML = vorname;
            td3.innerHTML = sex;
            td4.innerHTML = data;
            td5.innerHTML = age;
            td6.innerHTML = nation;
            td7.innerHTML = verein;
            td8.innerHTML = rank;
            ratingButton.innerHTML = '<button type="button" class="btn btn-primary" data-toggle="modal" data-target="" onclick="FillTboxes(null)">Bewerten</button>'
            //ControlDiv.innerHTML = '<button id="bearbeiten-button-id" type="button" class="btn btn-primary my-2 ml-2" data-toggle="modal" data-target="#exampleModalCenter">Bearbeiten</button>'

            var bearbeitenButton = document.createElement("button");
            bearbeitenButton.type = "button";
            bearbeitenButton.className = "btn btn-primary my-2 ml-2";
            bearbeitenButton.dataset.toggle = "modal";
            bearbeitenButton.dataset.target = "#exampleModalCenter";
            bearbeitenButton.innerText = "Bearbeiten";
            bearbeitenButton.addEventListener('click', function() {
                // Hier den Index der Zeile übergeben, die bearbeitet werden soll
                FillTboxes(trow.rowIndex-1);  // Übergeben Sie den aktuellen Wert von 'Nummer' als Index
            });
            ControlDiv.appendChild(bearbeitenButton);

            trow.appendChild(td1);
            trow.appendChild(td2);
            trow.appendChild(td3);
            trow.appendChild(td4);
            trow.appendChild(td5);
            trow.appendChild(td6);
            trow.appendChild(td7);
            trow.appendChild(td8);
            trow.appendChild(ratingButton);
            trow.appendChild(ControlDiv);

            tbody.appendChild(trow);


                /*// Hier können Sie sicher sein, dass die Liste nicht leer ist
                console.log("Listlänge:", teilnehmerList.length);

                console.log("Inhalt der Liste:");
                //console.log("Nummer:", Nummer);
                teilnehmerList.forEach((teilnehmer) => {
                    console.log(`Teilnehmer ${teilnehmer[0]}:`, teilnehmer.slice(1)); // Nummer überspringen
                });*/
            
        }

        
    
        var NameMod = document.getElementById('NameMod');
        var VornameMod = document.getElementById('VornameMod');
        var SexMod = document.getElementById('SexMod');
        var DataMod = document.getElementById('DataMod');
        var AgeMod = document.getElementById('AgeMod');
        var NationMod = document.getElementById('NationMod');
        var VereinMod = document.getElementById('VereinMod');
        var RankMod = document.getElementById('RankMod');

        var BTNmodUpd = document.getElementById('UpdModBtn');
        var BTNmodDel = document.getElementById('DeleteModBtn');
        
        function FillTboxes(index){
            console.log("Index:", index);


            if(index==null){
                NameMod.value = "";
                VornameMod.value = ""; 
                SexMod.value = "";
                DataMod.value = "";
                AgeMod.value = "";
                NationMod.value = "";
                VereinMod.value = "";
                RankMod.value = "";
            } else {
                //--index;
                NameMod.value = teilnehmerList[index][0];
                VornameMod.value = teilnehmerList[index][1]; 
                SexMod.value = teilnehmerList[index][2];
                DataMod.value = teilnehmerList[index][3];
                AgeMod.value = teilnehmerList[index][4];
                NationMod.value = teilnehmerList[index][5];
                VereinMod.value = teilnehmerList[index][6];
                RankMod.value = teilnehmerList[index][7];
            }
        }

        function AddAllTeilnehmer(Teilnehmer) {
            Nummer = 0;
            tbody.innerHTML = "";
            Teilnehmer.forEach(element => {
                
                AddTeilnehmer(
                    element.Name,
                    element.Vorname,
                    element.Geburstdatum,
                    element.Alter,
                    element.Graduierung,
                    element.Geschlecht,
                    element.Nationalität,
                    element.Verein,
                    element.Schnellbogenschießen.Platzierung,
                    element.Schnellbogenschießen.Sekunden,
                );
            });
        }

    //-------- FullName merken und vorschlagen-------->
    </script>
</body>
</html>